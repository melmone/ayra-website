<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ご購入手続き | Ayra</title>
  <script type="module" src="js/firebase-init.js"></script>
  <script type="module" src="js/product-soldout.js" defer></script>
  <link rel="stylesheet" href="stylesheet.css">
  
</head>

<body>

  <h2>ご購入手続き</h2>

  <form class="checkout-form" id="checkout-form">
    <label for="checkout-email" class="checkout-label">メールアドレス:</label><br>
      <input id="checkout-email" type="email" name="email" class="checkout-input" required>
    <br><br>

    <label for="checkout-address" class="checkout-label">お届け先住所:</label><br>
      <textarea id="checkout-address" name="address" class="checkout-textarea" rows="4" required></textarea>
    <br><br>
  </form>

  <h3>お支払い</h3>
  <!-- ▼ここにPayPalのコードを貼り付け▼ -->
  <div id="paypal-button-container"></div>
  
  <br>
  <button class="back-button" onclick="history.back()">← カートに戻る</button>

  <script src="https://www.paypal.com/sdk/js?client-id=AT8cSY5uNZPTDuIEpFSCkQ4_mIFeEU30WAuXl9wK64vIodxOA9R2EXBatYNxt50vKM76XRE_TFztEnH0&currency=JPY"></script>
  
  <script>
    const cart  = JSON.parse(localStorage.getItem('cart')) || [];
    const total = cart.reduce((s, i) => s + i.price, 0);

    paypal.Buttons({
      createOrder: (data, actions) =>
        actions.order.create({ 
          purchase_units: [{ 
            amount: { value: total.toString() } 
          }] 
        }),

      // 決済承認後の処理
      onApprove: async (data, actions) => {
        try {
          // 1) 決済を確定して details を取得
          const details = await actions.order.capture();
          console.log("PayPal capture details:", details);

          // 2) details から必要な情報を抜き出し
          const orderId      = details.id;
          const status       = details.status;
          const payerName    = `${details.payer.name.given_name} ${details.payer.name.surname}`;
          const payerEmail   = details.payer.email_address;
          const shippingInfo = details.purchase_units[0].shipping.address;
          const emailInput    = document.getElementById('checkout-email').value;
          const amount       = details.purchase_units[0].amount.value;
          const currency     = details.purchase_units[0].amount.currency_code;
          const addressInput = document.getElementById('checkout-address').value;

          // 3) Firebase に注文データを保存
          await window.db.ref('orders').push({
            orderId,
            status,
            payerName,
            payerEmail,
            shipping: shippingInfo,
            noteAddress: addressInput,
            email: emailInput,
            amount,
            currency,
            cart,
            purchasedAt: Date.now()
          });

          // 4) soldOut フラグ更新（カートの商品すべて）
          const updates = {};
          cart.forEach(item => {
            updates[`products/${item.id}/soldOut`] = true;
          });
          await window.db.ref().update(updates);

          // 5) ユーザーへのフィードバック＆遷移
          alert(`決済完了！\n注文ID: ${orderId}\n合計: ¥${amount}`);
          localStorage.removeItem('cart');
          window.location.href = 'index.html';

        } catch (err) {
          console.error(err);
          alert('決済完了時にエラーが発生しました。');
        }
      }
    }).render('#paypal-button-container');
  </script>



</body>
</html>
