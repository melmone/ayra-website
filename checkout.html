<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ご購入手続き | Ayra</title>

  
  <!-- ① Firebase SDK 読み込み -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js"></script>
  
  <!-- ② Firebase 初期化 -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAJkO5HyZPp4D_D3YW_nle-SkcbBfp867c",
      authDomain: "ayra-rings.firebaseapp.com",
      databaseURL: "https://ayra-rings-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "ayra-rings",
      storageBucket: "ayra-rings.firebasestorage.app",
      messagingSenderId: "285508091332",
      appId: "1:285508091332:web:6d272347377b4669cb3891"
    };
    // ③ 初期化
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
  </script>

  <!-- 以降、あなたのカスタム CSS や JS -->
  <link rel="stylesheet" href="stylesheet.css">
  <script src="js/main.js" defer></script>
  
</head>

<body>

  <h2>ご購入手続き</h2>

  <form class="checkout-form" id="checkout-form">
    <label for="checkout-email" class="checkout-label">メールアドレス:</label><br>
      <input type="email" name="email" class="checkout-input" required>
    <br><br>

    <label for="checkout-address" class="checkout-label">お届け先住所:</label><br>
      <textarea id="checkout-address" name="address" class="checkout-textarea" rows="4" required></textarea>
    <br><br>
  </form>

  <h3>お支払い</h3>
  <!-- ▼ここにPayPalのコードを貼り付け▼ -->
  <div id="paypal-button-container"></div>
  
  <br>
  <button class="back-button" onclick="history.back()">← カートに戻る</button>

  <script src="https://www.paypal.com/sdk/js?client-id=AT8cSY5uNZPTDuIEpFSCkQ4_mIFeEU30WAuXl9wK64vIodxOA9R2EXBatYNxt50vKM76XRE_TFztEnH0&currency=JPY"></script>
  
  <script>
    const cart  = JSON.parse(localStorage.getItem('cart')) || [];
    const total = cart.reduce((s, i) => s + i.price, 0);

    paypal.Buttons({
      createOrder: (_, actions) =>
        actions.order.create({ 
          purchase_units: [{ 
            amount: { value: total.toString() } 
          }] 
        }),

      onApprove: (_, actions) =>
        actions.order.capture()
          .then(() => {
            // 2) cart の中にある全商品の soldOut=true をまとめて更新
          const updates = {};
          cart.forEach(item => {
            // item.id は items.json のキー（例 "A001-10①"）
            updates[`products/${item.id}/soldOut`] = true;
          });
          // Realtime Database のルートで一括更新
          return db.ref().update(updates);
        })
          .then(() => {
            // 3) UI フィードバック
          alert('決済が完了しました！該当商品を SOLD OUT にしました。');
          // 4) カートをクリア
          localStorage.removeItem('cart');
          // 5) 好きなページへリダイレクト（例：トップページ or サンクスページ）
          window.location.href = 'index.html';
        })
        .catch(err => {
          console.error(err);
          alert('エラーが発生しました。コンソールログを確認してください。');
        })
  }).render('#paypal-button-container');
</script>


</body>
</html>
